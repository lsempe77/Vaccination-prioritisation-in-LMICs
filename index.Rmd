---
title: "Simulation of vaccination scenarios in low- and middle- countries"
author: "Lucas Sempe"
output:
  bookdown::word_document2:
bibliography: references.bib
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = F,message = F, comment = F, warning = F,
                      dpi=500,fig.width=8)

library(bookdown)
library(tidyverse)
library(nimue)
library(readxl)
library(gtsummary)
library(future)
library(furrr)
library(flextable)


```

```{r, cache=TRUE}

source("models.R", local = knitr::knit_global())

```

# Introduction

A year after the launch of the COVID-19 vaccine immunisation process across countries, we note two facts. Vaccines have been proved very effective against existing variants of COVID-19 both in terms of preventing the acquisition of severe disease, hospitalization and death; and also in terms of slowing down the spread of infections [@imai2021]. 

Although the way out of the pandemics requires a worldwide solution, we note that the vaccine roll-out has been very inequality across countries. While many developed nations will reach high vaccination coverages by the end of 2021, many low- and middle- income countries (LMICs) are still lagged on their vaccination process.

Until the vaccination coverage reachs the vast majority of the worldwide population, there will still be high uncertainty on the future development of the pandemics during the next years. Many factors may play a role as drivers of local or global outbreaks. Many countries been already through more than 1 epidemic wav eexplained by factors such as the appearance of new variants or the easing of non-pharmaceutical interventions. 

Considering this uncertainty, in this paper we simulate different scenarios to capture the potential magnitude of the lack of impact of vaccination uptake in LMICs in terms of infections, hospitalisation and deaths during 2020. This uncertainty increases in LMICs, where epidemiological is still no robust [@lloyd-sherlock2020]. 

These scenarios are built to answer to an ethical framework that aims to find a best possible allocation of COVID-19 vaccines. Our ethical guidelines are the following: we aim to maximise societal health benefits; prioritise those worst-off without the vaccines; and promote equality, where individuals under circumstances shall be treated equally [@emanuel2020]. These principles become operational in terms of saving the most lives, and then the most life-years; prioritise the most vulnerable populations such as older and immunodeficient people; and protect health workers.



# Empirical strategy

We compute different models based on a previously developed extended age-structured deterministic compartmental model of SARS-CoV-2 transmission [@hogan2021;@walker2020]. This model considers the progression of the population across transmission compartments (susceptible, exposed, infected, recovered), clinical pathways (need for hospitalisation, oxygen and/or intensive care) and vaccination uptake considering factors such as vaccine availability, prioritisation and coverage. The infection transmission also considers age-based contact matrices and loss of acquired immunity. The model considers the efficacy of the vaccine both against the infection and severe disease. 

Our models have fixed and varying parameters across models. The varying parameters were chosen to simulate key factors affecting the evolution of the pandemics and the vaccination process. The changing parameters are:

-   We model two different vaccination strategies. The first disaggregated the population into 5-year groups (where people over 80 is considered in one group) and giver priority to the oldest age groups until a maximum coverage is reached.The second strategy does not prioritise any age groups, which could be consistent with an ongoing vaccination process where vaccines are open to the total adult population.

-   The maximum vaccine coverage for each age group. We use maximum coverage values from 68% to 95%. Population coverage is adjusted post hoc based on Model vaccine coverage and $S_{{0}_{age-group}}$ to facilitate the interpretation of results.

-   A constant basic reproduction number, based on conservative projections ranging from 1.1 to 2. This assumes the pandemics is not suppressed during 2020.

-   A number of vaccines given per day, which is based on historical data from each country. In the case of India, the parameter for maximum vaccines per day are set in 3, 4 and 5 million per day.


Additionally, the following parameters are fixed across all models. The time period for the analysis is year. The duration of the mean duration of naturally acquired immunity and of vaccine-derived immunity is set to 365 days. We set the vaccine efficacy preventing 50% of infections and 90% of efficacy against severe disease, which requires hospitalisations, across all age groups . Seeding cases were set on 200,000 cases (equivalent to to 10 days of official data in India and Peru) after exploring a wider range without finding relevant differences on the results. Additional parameters such as hospital capacity and ICU and parameters by age groups such as probabilities of hospitalisation, probability of severe disease, among others, are found in the appendix. Epidemiological and vaccination parameters were compiled by Hogan et al [-@hogan2021] and updated in the R package ['nimue'](https://github.com/mrc-ide/nimue), where original sources are given.  Basic reproduction numbers (R0) and mortality data is collected from Our World in Data [@OurWorldinData2021]. Finally, vaccine uptake per group age statistics were collected from national databases.

For each scenario, we estimate the following outcomes: hospitalisations averted, deaths averted, proportion of deaths averted, years life saved and number of vaccines. The computation of those outcomes are based on the comparison of each model with their counterfactual models. In the case of India, the counterfactual models are set with the maximum vaccination coverage of 68% and all other parameters are similar across models. The counterfactual models represents 35% of the population coverage. The maximum vaccination coverage of 68% represents 35% of the population coverage, which is similar to population coverage in October 2020.

Because of the ongoing vaccination, the initial number of people in the first state of the transmission model, those susceptible to the disease, ($S_{{0}_{age-group}}$), is adjusted as $S_{{0}_{age-group}} = \Big(Population - \frac{Vaccinated}{2}\Big)*Proportion_{inmunity-loss}$. $Proportion_{inmunity-loss}$ is set to .9, which represents 10% of the already vaccinated population we assume to be on the initial susceptible state during 2021.

Considering the stochastic nature of the modelling strategy, we run 10 times each combination of parameters and average the outcome results. The combination of the different parameters provide 900 different scenarios and 9000 models for each country. 

# India

```{r}

owid.covid.data <- read.csv("owid-covid-data.csv")

reproduction_rate_India<- owid.covid.data %>% 
  filter(location == "India") %>% 
  select(date,reproduction_rate) %>% mutate(date=lubridate::ymd(date))

# reproduction_rate_India %>% 
# ggplot()  + 
#   geom_hline(yintercept = 1,linetype=2,colour="darkorange")+
#   geom_line(aes(date,reproduction_rate)) + theme_light() +
#   labs(title = "Reproduction rate over time - India",
#               subtitle = "Based on reported cases",
#               caption = "Data source: Our World in Data")+
#   xlab("Date") + ylab("Reproduction Rate") + 
#   scale_x_date(breaks = "2 months", labels=scales::date_format("%b%y"),
#                 limits=c(as.Date("2020-03-15"), as.Date("2021-09-30")))
  

```

To the current date (16 October 2021), India reports 451,435 deaths during the two-wave epidemic in the country with a peak of weekly deaths of 4190 deaths computed as rolling average. R0 ranges from 0.68 to 2.27 across time (see Figure \@ref(fig:mortality-India)). We observe a lack of correspondence between both (which also occurs if the mortality data is lagged by weeks or a month), which raises concerns regarding the quality of the data.

```{r mortality-India, fig.cap="7-day rolling average of reported deaths and R0 - India"}


mortality_India<- owid.covid.data %>% 
  filter(location == "India") %>% 
  select(date,new_deaths) %>% mutate(date=lubridate::ymd(date))

# 
# mortality_India %>% mutate(cma = zoo::rollmean(new_deaths, 7, na.pad=TRUE)) %>%
#   summarise(max=max(cma,na.rm=T),
#             mean=mean(cma,na.rm=T))



scl = 2000

mortality_India %>% left_join(reproduction_rate_India) %>%
ggplot()  + 
   geom_line(aes(date,y=zoo::rollmean(reproduction_rate, 7, na.pad=TRUE)*scl),colour="darkorange") + 
    geom_line(aes(x=date,y=zoo::rollmean(new_deaths, 7, na.pad=TRUE)),color = "darkgreen") +  
      theme_light() +
  labs(title = "7-day rolling average of reported deaths and basic reproduction numbers - India",
              subtitle = "Based on official data",
              caption = "Data source: Our World in Data")+
  xlab("") +  ylab("Deaths") + 
  scale_x_date(breaks = "2 months", labels=scales::date_format("%b%y"),
                limits=c(as.Date("2020-03-15"), as.Date("2021-09-30"))) + 
  scale_y_continuous(labels = scales::comma,
    sec.axis = sec_axis(~./scl, name="Reproduction Rate")) +
    theme(axis.title.y.right = element_text(color = "darkorange"),
          axis.text.y.right = element_text(color = "darkorange"),
          axis.title.y.left = element_text(color = "darkgreen"),
          axis.text.y.left = element_text(color = "darkgreen"))


```

```{r}

# summary(reproduction_rate_India$reproduction_rate)

# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  0.680   0.910   1.010   1.103   1.230   2.270      46
  
mortality_total_India<- owid.covid.data %>% 
  filter(location == "India") %>% 
  select(date,total_deaths) %>% mutate(date=lubridate::ymd(date))

#mortality_total_India %>% summarise(total=max(total_deaths,na.rm=T)) # 451435


```

The Indian Government reports weekly vaccinations uptake by three age groups: 15 to 44, 45 to 59, and people over 60 (Figure \@ref(fig:vaccination-India)). Data is only provided by vaccines and not by people fully vaccinated. Until October 15, 946 millions vaccines have been given, which represents 34.3% of the population vaccinated with 2 dosis (which does not mean the same person received two vaccines). Vaccination uptake has been increasing since the end of July 2021, where more than 30 million of weekly vaccines have been given each week. This reach a peak of 66.9 million vaccines applied in a week during the September 2021. However, the trend is downwards in October 2021. The proportion of the vaccines given per population for the age groups 15 to 44, 45 to 59, and people over 60 groups is 33.3%, 61.9% and 57.3%, respectively.

```{r vaccination-India, fig.cap="Weekly vaccinations by age groups - India"}

vaccination_India <-  read_excel("dashboard_export_19oct.xlsx")

vaccination_India$week<-c(seq(3,41,1))
  
# 66891331 (or 66891297) in week 11 Sep-17 Sep -> 9555904 daily in that week


vaccination_India %>% 
  pivot_longer(vac_18_45:vac_60_above, names_to = "Age_group") %>% 
  mutate (Age_group = case_when(Age_group=="vac_18_45" ~ '18 - 44',
                                Age_group=="vac_45_60" ~ '45 - 59',
                                T ~ '60+')) %>%
  ggplot(aes(week,value/7,colour=Age_group,group=Age_group)) + geom_line() + 
  theme_light() + 
  scale_x_continuous(breaks = seq(3,42,3)) + 
  scale_y_continuous(breaks = seq(0,7e6,1e6),
    labels = scales::comma) + 
  xlab ("Weeks 2021") + 
  ylab ("Average daily vaccination") +
  labs(colour="Age group") +
    labs(title = "Weekly vaccinations by age groups - India",
              subtitle = "Based on official data",
              caption = "Data source: https://dashboard.cowin.gov.in/")


```

```{r}


population <- nimue:::init(squire::get_population("India")$n, seeding_cases = 100000)
population<-population$S_0

population2 <- c(sum(population[3:9,1]),sum(population[10:12,1]),sum(population[13:17,1])) %>% as.data.frame()


colnames(population2)[1]<- "population"
Age_group<-c('18 - 44','45 - 59','60+')  

population2<-cbind(Age_group,population2)

# vaccination_India %>% 
#   pivot_longer(vac_18_45:vac_60_above, names_to = "Age_group") %>% 
#   mutate (Age_group = case_when(Age_group=="vac_18_45" ~ '18 - 44',
#                                 Age_group=="vac_45_60" ~ '45 - 59',
#                                 T ~ '60+')) %>% group_by(Age_group) %>%
#   summarise(vaccination=sum(value)) %>% left_join(population2) %>%
#   mutate (proportion = (vaccination/2)/population) 

# Age_group vaccination population proportion
#   <chr>           <dbl>      <dbl>      <dbl>
# 1 18 - 44     531157060  797909859      0.333
# 2 45 - 59     256802443  207522412      0.619
# 3 60+         159961842  139610480      0.573
  
```

## Results of simulations 

Figure \@ref(fig:simulations-ideal) presents 8 panels with basic reproduction numbers ranging from 1.1 to 1.8. The estimated number of deaths averted range from 2.5 millions to 4 millions across basic reproduction number scenarios. In all cases, the prioritisation of older people in the vaccination strategy leads to increasing returns in numbers of deaths averted when vaccine coverage is higher. Differently, in the case of the lack of prioritisation, the number of deaths averted remain similar across different levels of vaccine coverage. Models between vaccination strategies in higher R0 scenarios suggest differences larger than 3 million deaths averted. The number of vaccines per day do not play a key role if the vaccination strategies prioritise older people while it does affect the number of deaths averted in the case of lack of a vaccination strategy.

```{r simulations-ideal, fig.cap="Deaths averted based on simulated scenarios - India"}

out_format %>% group_by(final_coverage,R0,vaccine_coverage_mat,max_vaccine) %>%
  mutate(deaths_averted=mean(deaths_averted))%>%
  ggplot() + geom_point(aes(final_coverage,deaths_averted,colour=vaccine_coverage_mat,
                            shape=as.factor(max_vaccine)))+
  facet_wrap(~R0,ncol = 5) + theme_light() +
  scale_y_continuous(labels = scales::comma) +
   scale_x_continuous(labels = scales::percent,limits = c(.36,1)) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin()) + 
  labs(title = "Simulations of Vaccination models - India",
       caption = "Data source: Authors' own")+
  xlab("Population maximum coverage") +  ylab("Deaths averted") + 
   scale_colour_manual("Vaccine prioritisation",values = c("darkgreen", "darkorange"), 
                       labels = c("No priority", "Older People"))+
  scale_shape_discrete("Mean vaccines/day",
                      labels = c("3 million", "4 million", "5 million"))

```

Figure \@ref(fig:infections-ideal) presents the same simulated scenarios to compute the potential number of infections averted. In this case, the R0 parameter plays a major role, where lower reproduction rates represent higher numbers of infections averted.

```{r infections-ideal, fig.cap="Infections averted based on simulated scenarios - India"}

out_format %>% group_by(final_coverage,R0,vaccine_coverage_mat,max_vaccine) %>%
  mutate(infections_averted=mean(infections_averted))%>%
  filter(R0<1.9)%>%
  ggplot() + geom_point(aes(final_coverage,infections_averted,colour=vaccine_coverage_mat,
                            shape=as.factor(max_vaccine)))+
  facet_wrap(~R0,ncol = 4) + theme_light() +
  scale_y_continuous(labels = scales::comma) +
   scale_x_continuous(labels = scales::percent,limits = c(.36,1)) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin()) + 
  labs(title = "Simulations of Vaccination models - India",
       caption = "Data source: Authors' own")+
  xlab("Population maximum coverage") +  ylab("Infections averted") + 
   scale_colour_manual("Vaccine prioritisation",values = c("darkgreen", "darkorange"), 
                       labels = c("No priority", "Older People"))+
  scale_shape_discrete("Mean vaccines/day",
                      labels = c("3 million", "4 million", "5 million"))

```

Table \@ref(tab:vaccination-ideal) shows a conservative scenario where 80% of the population is immunised across 2022. The scenario implies an R0 equal to 1.1. In this case, 35% of deaths averted if 5 million people is vaccinated per day prioritising the vaccination of older people. This represents 1,872,683 deaths averted, equivalent to 13,048,505 years of life saved. Under a lack of a vaccination strategy, deaths saved are reduced to 774,500.

```{r vaccination-ideal, tab.cap="Sccenario with 80% of population coverage and low R0 - India"}

# ideal<-out_format %>% select(final_coverage,R0,seed,max_vaccine,vaccine_coverage_mat,
#                              infections_averted,hospitalisations_averted,
# deaths_averted,deaths_averted_prop,years_life_saved,vaccine_n) %>%
#   mutate(final_coverage=round(final_coverage,2))
# 
# table(ideal$final_coverage)


ideal<-out_format %>% select(final_coverage,R0,seed,max_vaccine,vaccine_coverage_mat,
                             infections_averted,hospitalisations_averted,
deaths_averted,deaths_averted_prop,years_life_saved,vaccine_n) %>% 
  mutate(final_coverage=round(final_coverage,2)) %>%
  filter (final_coverage == .8 & R0 == 1.1) %>% 
  group_by(final_coverage,R0,max_vaccine,vaccine_coverage_mat) %>%
  summarise(infections_averted=mean(infections_averted),
    hospitalisations_averted= mean(hospitalisations_averted),
deaths_averted=mean(deaths_averted),deaths_averted_prop=mean(deaths_averted_prop),
years_life_saved=mean(years_life_saved),vaccine_n=mean(vaccine_n))


ideal<-flextable::flextable(ideal) 

ideal <- set_formatter( x = ideal,
                        infections_averted=function(x) sprintf("%.0f", x),
        max_vaccine = function(x) sprintf("%.0f", x),
        years_life_saved = function(x) sprintf("%.0f", x),
                vaccine_n = function(x) sprintf("%.0f", x))

ideal

```

## Peru

```{r, cache=TRUE}

#source("models_Peru.R", local = knitr::knit_global())

```





## Results of simulations 




# Discussion
 
Limitation -  constant transmission rate
think about other parameters

assumes people vaccinate not dosis


# Epidemiological and vaccination parameters used across models and countries

### Parameters 1

```{r}

param1<-nimue:::default_probs()

param1<-do.call(cbind.data.frame, param1)

age_groups<-c(
"0 to 4",
"5 to 9",
"10 to 14",	
"15 to 19",	
"20 to 24",
"25 to 29",	
"30 to 34",	
"35 to 39",	
"40 to 44",	
"45 to 49",	
"50 to 54",	
"55 to 59",	
"60 to 64",	
"65 to 69",	
"70 to 74",	
"75 to 79",	
"80+")

ft_1<-flextable::flextable(cbind(age_groups,param1)) 
ft_2 <- autofit(ft_1)
ft_2
```

### Parameters 2

```{r}

param2<-nimue:::default_vaccine_pars()

param2<-do.call(cbind.data.frame, param2)

param2<-param2[1,]

ft_3<-flextable::flextable(param2)

ft_4 <- autofit(ft_3)

ft_4
```

### Parameters 3

```{r}

param3<-nimue:::default_durations()

param3<-do.call(cbind.data.frame, param3)

ft_5<-flextable::flextable(param3) 

ft_6<- autofit(ft_5)

ft_6

```

### Parameters 4

```{r}

param4<-squire::get_healthcare_capacity(country="India")  
param4_Peru<-squire::get_healthcare_capacity(country="Peru")  

param4<-do.call(cbind.data.frame, param4)
param4_Peru<-do.call(cbind.data.frame, param4_Peru)


param4<- param4 %>% bind_rows(param4_Peru)
param4$Country<-c("India","Peru")

ft_7<-flextable::flextable(param4) 

ft_8<- autofit(ft_7)

ft_8

```

# References
